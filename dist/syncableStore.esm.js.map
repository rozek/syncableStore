{"version":3,"file":"syncableStore.esm.js","sources":["../src/syncableStore.ts"],"sourcesContent":["/*******************************************************************************\n*                                                                              *\n*                                SyncableStore                                 *\n*                                                                              *\n*******************************************************************************/\n\n  import {\n    syncedStore, SyncedDoc,SyncedArray,SyncedMap,SyncedXml,SyncedText, Box,boxed,\n    observeDeep, areSame,\n    Y, getYjsDoc as _getYjsDoc, getYjsValue\n  } from '@syncedstore/core'\n\n/**** syncableStore ****/\n\n  const StoreOfRoot:WeakMap<any,any> = new WeakMap()\n\n  export function syncableStore (\n    Callback:Function, reportClosestArrayObject:boolean = false, sharedDoc?:any\n  ):any {\n    const sharedStore = syncedStore({ Root:{} },sharedDoc)\n      const StoreRoot = sharedStore.Root\n      StoreOfRoot.set(StoreRoot,sharedStore)\n\n      StoreEntryOfYjsItem.set(getYjsValue(StoreRoot),StoreRoot)\n\n      if (Callback != null) {\n        observeDeep(StoreRoot,\n          (...ArgList:any[]) => reportChanges(ArgList[1],StoreRoot,reportClosestArrayObject,Callback)\n        )\n      }\n    return sharedStore.Root\n  }\n\n/**** getYjsDoc (modified for syncableStore) ****/\n\n  export function getYjsDoc (StoreRoot:any) {\n    const Store = StoreOfRoot.get(StoreRoot)\n    if (Store == null) throw new Error(\n      'NoSuchStore: the given object is not a valid \"SyncableStore\"'\n    )\n\n    return _getYjsDoc(Store)\n  }\n\n/**** transact (modified for syncableStore) ****/\n\n  export function transact (StoreRoot:any, Callback:Function) {\n    const YjsDoc = getYjsDoc(StoreRoot)\n    if (YjsDoc == null) throw new Error(\n      'NoYjsDoc: no Yjs document for the given \"SyncableStore\" found'\n    )\n\n// @ts-ignore TS2345 don't be too strict regarding the function signature\n    YjsDoc.transact(Callback)\n  }\n\n/**** reportChanges ****/\n\n  function reportChanges (\n    YjsTransaction:any, StoreRoot:any, reportClosestArrayObject:boolean,\n    Callback:Function\n  ):void {\n    const Transaction:Map<any,string[]> = new Map()\n      YjsTransaction.changed.forEach((PropertySet:any,Container:any) => {\n        let changedEntry = StoreEntryForYjsItem(Container,StoreRoot)\n        if (changedEntry != null) {\n          if (Array.isArray(changedEntry) && reportClosestArrayObject) {\n            reportClosestObjectWithArray(Container,StoreRoot,Transaction)\n          } else {\n            if (PropertySet.size === 0) {\n              memoizeContentsOf(changedEntry)\n              Transaction.set(changedEntry,[])\n            } else {\n              for (let Property of PropertySet) {\n                const Entry   = changedEntry[Property]\n                const YjsItem = getYjsValue(Entry)\n                if (YjsItem != null) {\n                  StoreEntryOfYjsItem.set(YjsItem,Entry)\n                  memoizeContentsOf(Entry)\n                }\n              }\n              Transaction.set(changedEntry,Array.from(PropertySet.values() as string[]).filter(\n                (Candidate:any) => Candidate != null\n              ))\n            }\n          }\n        }\n      })\n    Callback(Transaction)\n  }\n\n/**** StoreEntryForYjsItem ****/\n\n  const StoreEntryOfYjsItem:WeakMap<any,any> = new WeakMap()\n\n  function StoreEntryForYjsItem (YjsItem:any, StoreRoot:any):any {\n    const knownEntry = StoreEntryOfYjsItem.get(YjsItem)\n    if (knownEntry != null) { return knownEntry }\n\n    const outerYjsItem = (\n      YjsItem._item?.parent || YjsItem._start?.parent || getYjsValue(StoreRoot)\n    )\n    if (outerYjsItem == null) throw new Error(\n      'NoRegisteredRoot: the given store root has no Yjs counterpart'\n    )\n\n    const outerEntry = StoreEntryOfYjsItem.get(outerYjsItem)\n    if (outerEntry == null) { return undefined }\n\n    let matchingEntry = undefined\n    if (Array.isArray(outerEntry)) {\n      matchingEntry = outerEntry.find(         // scan array for changed element\n        (Candidate:any) => getYjsValue(Candidate) === YjsItem\n      )\n    } else {\n      const knownProperty = YjsItem._item?.parentSub\n      if (typeof knownProperty === 'string') {   // directly access changed item\n        matchingEntry = outerEntry[knownProperty]\n      } else {\n        matchingEntry = outerEntry.values().find(// scan object for changed item\n          (Candidate:any) => getYjsValue(Candidate) === YjsItem\n        )\n      }\n    }\n\n    if (matchingEntry != null) {                        // memoize changed entry\n      StoreEntryOfYjsItem.set(YjsItem,matchingEntry)\n      memoizeContentsOf(matchingEntry)\n    }\n\n    return matchingEntry                               // may still be undefined\n  }\n\n/**** reportClosestObjectWithArray ****/\n\n  function reportClosestObjectWithArray (\n    YjsItem:any, StoreRoot:any, Transaction:Map<any,string[]>\n  ):void {\n    const outerYjsItem = (\n      YjsItem._item?.parent || YjsItem._start?.parent || getYjsValue(StoreRoot)\n    )\n    if (outerYjsItem._start == null) {\n      let outerEntry = StoreEntryOfYjsItem.get(outerYjsItem)\n\n      let Property = Object.keys(outerEntry).find(// scan for prop. with YjsItem\n        (Candidate:any) => getYjsValue(outerEntry[Candidate]) === YjsItem\n      )\n      Transaction.set(outerEntry,[Property as  string])\n    } else {\n      reportClosestObjectWithArray(outerYjsItem,StoreRoot,Transaction)\n    }\n  }\n\n/**** reportChanges ****/\n\n  function memoizeContentsOf (StoreEntry:any):void {\n    let EntryList = (\n      Array.isArray(StoreEntry) ? StoreEntry : Object.values(StoreEntry)\n    )\n\n    EntryList.forEach((Entry:any) => {\n      const YjsItem = getYjsValue(Entry)\n      if (YjsItem != null) {\n        StoreEntryOfYjsItem.set(YjsItem,Entry)\n        memoizeContentsOf(Entry)\n      }\n    })\n  }\n\n  export {\n    SyncedDoc,SyncedArray,SyncedMap,SyncedXml,SyncedText, Box,boxed,\n    areSame,\n    Y, getYjsValue\n  }"],"names":["_getYjsDoc"],"mappings":"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"}